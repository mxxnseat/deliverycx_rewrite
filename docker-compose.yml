version: "3.9"
networks:
    mongodb_net:
        name: deliverycx_nest_mongodb_net
        driver: bridge
services:
    deliverycx_client:
        container_name: deliverycx_client
        build:
            context: .
            dockerfile: ./Dockerfile.webserver
        ports:
          - "80:80"
          - "443:443"
        depends_on:
          - deliverycx_backend
        volumes:
          - ./static:/static
          - ./certbot/www:/var/www/certbot/:ro
          - ./certbot/conf/:/etc/nginx/ssl/:ro
        networks:
          - mongodb_net
    deliverycx_backend:
        container_name: deliverycx_backend
        env_file:
            - ./server/.production.env
        depends_on:
            - redis
            - mongodb
        build:
            context: ./server
        networks:
          - mongodb_net
        links:
            - redis
        ports:
            - "5000:5000"
    redis:
        image: redis
        command:
            - "redis-server"
            - "--loglevel ${REDIS_LOGLEVEL:-warning}"
            - "--databases 2"
            - "--save 900 1"
            - "--save 300 10"
            - "--save 60 10000"
        volumes:
            - ./redis/data:/data
        networks:
          - mongodb_net
    mongodb:
        container_name: mongodb
        image: mongo
        volumes:
            - ./mongo/data:/data/db
        networks:
            - mongodb_net
    certbot:
        image: certbot/certbot
        volumes:
            - ./certbot/www/:/var/www/certbot/:rw
            - ./certbot/conf/:/etc/letsencrypt/:rw
